<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valorant Routine Tracker (rutina de nats)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #07090f;
      --panel: #0b0f1a;
      --border:#1b2440;
      --text:#e7ecff;
      --muted:#9aa4c7;
      --red:#ff4655;
      --good:#3cff88;
      --bad:#ff7a7a;
      --blue:#6ea8ff;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(31,59,122,.25), transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, rgba(255,70,85,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{ max-width: 1200px; margin: 28px auto; padding: 0 18px 36px; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom: 12px; }
    h1{ margin:0; font-size: 28px; letter-spacing: .2px; }
    .subtitle{ margin-top:6px; color: var(--muted); font-size: 14px; }

    .badge{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,70,85,.14), rgba(31,59,122,.10));
      padding: 10px 12px; border-radius: 999px;
      color: var(--text); font-weight: 800; font-size: 13px;
      box-shadow: var(--shadow);
      white-space:nowrap;
    }

    .toast{
      display:none;
      margin: 0 0 14px;
      border: 1px solid rgba(60,255,136,.28);
      background: rgba(60,255,136,.08);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      font-weight: 900;
    }
    .toast b{ color: var(--good); }

    .grid{ display:grid; grid-template-columns: 1fr 1.35fr; gap: 16px; align-items:start; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin: 0 0 10px; font-size: 18px; letter-spacing: .2px; }

    label{ display:block; margin-top: 10px; color: var(--muted); font-size: 13px; font-weight: 800; }
    input, select{
      width:100%; margin-top: 6px; padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(11,15,26,.85);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    input::placeholder{ color: rgba(154,164,199,.6); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 150px; }

    .gridInputs{ display:grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .gridInputs.three{ grid-template-columns: repeat(3, 1fr); }
    .gridInputs.five{ grid-template-columns: repeat(5, 1fr); }

    .muted{ color: var(--muted); font-size: 13px; margin-top: 6px; }
    .divider{ height:1px; background: rgba(27,36,64,.7); margin: 14px 0; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    button{
      cursor:pointer;
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 900;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size: 14px;
    }
    button.primary{
      border-color: rgba(255,70,85,.55);
      background: linear-gradient(180deg, rgba(255,70,85,.25), rgba(255,70,85,.10));
    }
    button.danger{
      border-color: rgba(255,122,122,.5);
      background: rgba(255,122,122,.10);
    }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi{
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(11,15,26,.75);
      padding: 12px;
    }
    .kpi .t{ color: var(--muted); font-size: 12px; font-weight: 900; }
    .kpi .v{ font-size: 22px; font-weight: 900; margin-top: 6px; }
    .kpi .s{ color: var(--muted); font-size: 12px; margin-top: 3px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(11,15,26,.7);
      color: var(--text);
      font-size: 12px;
      font-weight: 900;
    }
    .dot{ width:8px; height:8px; border-radius: 999px; background: var(--red); }
    .dot.good{ background: var(--good); }
    .dot.bad{ background: var(--bad); }
    .dot.blue{ background: var(--blue); }

    .weekProgress{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
    .dayBox{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(11,15,26,.6);
      text-align:center;
      font-weight: 900;
      font-size: 12px;
    }
    .dayBox span{ display:block; margin-top: 6px; font-size: 12px; font-weight: 900; color: var(--muted); }
    .done{ border-color: rgba(60,255,136,.35); background: rgba(60,255,136,.10); }
    .miss{ border-color: rgba(255,70,85,.25); background: rgba(255,70,85,.06); }

    table{ width:100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; border-radius: 14px; overflow:hidden; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid rgba(27,36,64,.7); text-align:left; vertical-align: top; }
    th{ color: var(--muted); font-size: 12px; font-weight: 900; letter-spacing:.2px; }

    .tagPB{
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid rgba(60,255,136,.28);
      background: rgba(60,255,136,.08);
      color: var(--text);
      border-radius: 999px;
      padding: 4px 8px;
      font-weight: 900;
      font-size: 12px;
      margin-left: 8px;
    }

    .insightsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .miniCard{
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(11,15,26,.75);
      padding: 12px;
      min-height: 92px;
    }
    .miniTitle{ color: var(--muted); font-weight: 900; font-size: 12px; }
    .miniValue{ margin-top: 6px; font-size: 16px; font-weight: 900; }
    .miniHint{ margin-top: 6px; color: var(--muted); font-size: 12px; }

    .deltaUp{ color: var(--good); }
    .deltaDown{ color: var(--bad); }
    .deltaFlat{ color: var(--muted); }

    .streakWrap{
      margin-top: 10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(11,15,26,.75);
      padding: 12px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(27,36,64,.7);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255,70,85,.55), rgba(60,255,136,.55));
      border-radius: 999px;
      transition: width .25s ease;
    }

    canvas{ width:100%; height: 160px; display:block; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
      .gridInputs{ grid-template-columns: repeat(2, 1fr); }
      .gridInputs.three{ grid-template-columns: repeat(2, 1fr); }
      .gridInputs.five{ grid-template-columns: repeat(2, 1fr); }
      .insightsGrid{ grid-template-columns: 1fr; }
      .badge{ display:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Valorant Routine Tracker <span style="color:var(--muted); font-weight:800;">(rutina de nats)</span></h1>
        <div class="subtitle">100 bots (5 tiempos) ¬∑ Hard (15 reps) ¬∑ Deathmatch (5 DMs). Semana/Mes + PB + racha + gr√°fica.</div>
      </div>
      <div class="badge">üîª Dark Mode ¬∑ VLR Style</div>
    </div>

    <div class="toast" id="toastPB">üèÜ <b>NEW PB</b> ‚Äî </div>

    <div class="grid">
      <!-- FORM -->
      <div class="card">
        <h2>Nuevo registro</h2>

        <label>Fecha</label>
        <input id="date" type="date" />

        <div class="divider"></div>

        <h2 style="margin-top:0;">100 Bots</h2>
        <label>5 tiempos (seg)</label>
        <div class="gridInputs five">
          <input id="botT1" type="number" min="0" step="0.1" placeholder="T1 (ej: 62.5)" />
          <input id="botT2" type="number" min="0" step="0.1" placeholder="T2 (ej: 61.8)" />
          <input id="botT3" type="number" min="0" step="0.1" placeholder="T3 (ej: 63.1)" />
          <input id="botT4" type="number" min="0" step="0.1" placeholder="T4 (ej: 60.9)" />
          <input id="botT5" type="number" min="0" step="0.1" placeholder="T5 (ej: 62.0)" />
        </div>
        <div class="muted">Se calcula el promedio (avg) y el mejor (best = m√°s bajo).</div>

        <div class="divider"></div>

        <h2 style="margin-top:0;">Hard (15 repeticiones)</h2>
        <label>Bots destruidos en cada rep</label>
        <div class="gridInputs three">
          <input id="h1" type="number" min="0" step="1" placeholder="R1" />
          <input id="h2" type="number" min="0" step="1" placeholder="R2" />
          <input id="h3" type="number" min="0" step="1" placeholder="R3" />
          <input id="h4" type="number" min="0" step="1" placeholder="R4" />
          <input id="h5" type="number" min="0" step="1" placeholder="R5" />
          <input id="h6" type="number" min="0" step="1" placeholder="R6" />
          <input id="h7" type="number" min="0" step="1" placeholder="R7" />
          <input id="h8" type="number" min="0" step="1" placeholder="R8" />
          <input id="h9" type="number" min="0" step="1" placeholder="R9" />
          <input id="h10" type="number" min="0" step="1" placeholder="R10" />
          <input id="h11" type="number" min="0" step="1" placeholder="R11" />
          <input id="h12" type="number" min="0" step="1" placeholder="R12" />
          <input id="h13" type="number" min="0" step="1" placeholder="R13" />
          <input id="h14" type="number" min="0" step="1" placeholder="R14" />
          <input id="h15" type="number" min="0" step="1" placeholder="R15" />
        </div>
        <div class="muted">Calcula: total, promedio por rep, y mejor rep (m√°ximo).</div>

        <div class="divider"></div>

        <h2 style="margin-top:0;">Deathmatch (5 DMs)</h2>
        <label>Por DM: kills y deaths</label>
        <div class="gridInputs five">
          <input id="dm1k" type="number" min="0" step="1" placeholder="DM1 K" />
          <input id="dm1d" type="number" min="0" step="1" placeholder="DM1 D" />
          <input id="dm2k" type="number" min="0" step="1" placeholder="DM2 K" />
          <input id="dm2d" type="number" min="0" step="1" placeholder="DM2 D" />
          <input id="dm3k" type="number" min="0" step="1" placeholder="DM3 K" />
          <input id="dm3d" type="number" min="0" step="1" placeholder="DM3 D" />
          <input id="dm4k" type="number" min="0" step="1" placeholder="DM4 K" />
          <input id="dm4d" type="number" min="0" step="1" placeholder="DM4 D" />
          <input id="dm5k" type="number" min="0" step="1" placeholder="DM5 K" />
          <input id="dm5d" type="number" min="0" step="1" placeholder="DM5 D" />
        </div>
        <div class="muted">Calcula: totales, promedio por DM, K/D total y mejor K/D (DM).</div>

        <label>Notas (opcional)</label>
        <input id="notes" type="text" placeholder="Ej: Vandal only / Sheriff / foco en strafe" />

        <div class="btns">
          <button class="primary" id="addBtn">Guardar</button>
          <button class="danger" id="clearBtn">Borrar todo</button>
          <button id="exportBtn">Exportar CSV</button>
        </div>

        <div class="muted" style="margin-top:12px;">
          Score del d√≠a = <b>(HardTotal) + (K/D total √ó 10) ‚àí (BotsAvg/10)</b>.
        </div>
      </div>

      <!-- DASHBOARD -->
      <div>
        <div class="card">
          <div class="row" style="align-items:flex-end;">
            <div style="flex:1; min-width:240px;">
              <h2 style="margin:0;">Resumen</h2>
              <div class="muted" style="margin-top:6px;">Promedios por per√≠odo + se√±ales de progreso.</div>
            </div>
            <div style="flex:1; min-width:220px;">
              <label style="margin-top:0;">Vista</label>
              <select id="viewMode">
                <option value="week">Semana</option>
                <option value="month">Mes</option>
                <option value="all">Todo</option>
              </select>
            </div>
            <div style="flex:1; min-width:220px;">
              <label style="margin-top:0;">Per√≠odo</label>
              <select id="periodSelect"></select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="t">100 bots (avg)</div>
              <div class="v" id="kpiBotAvg">‚Äî</div>
              <div class="s">Seg (menor = mejor)</div>
            </div>
            <div class="kpi">
              <div class="t">100 bots (best)</div>
              <div class="v" id="kpiBotBest">‚Äî</div>
              <div class="s">Mejor tiempo</div>
            </div>
            <div class="kpi">
              <div class="t">Hard total (avg)</div>
              <div class="v" id="kpiHardTotal">‚Äî</div>
              <div class="s">Total/15 reps</div>
            </div>

            <div class="kpi">
              <div class="t">Hard (avg/rep)</div>
              <div class="v" id="kpiHardAvgRep">‚Äî</div>
              <div class="s">Promedio por rep</div>
            </div>
            <div class="kpi">
              <div class="t">DM K/D (avg)</div>
              <div class="v" id="kpiDmKD">‚Äî</div>
              <div class="s">K/D total (prom)</div>
            </div>
            <div class="kpi">
              <div class="t">Registros</div>
              <div class="v" id="kpiCount">0</div>
              <div class="s" id="kpiLast">√öltimo: ‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="pill"><span class="dot good"></span> Mejor d√≠a: <b id="bestDay">‚Äî</b></span>
            <span class="pill"><span class="dot bad"></span> Peor d√≠a: <b id="worstDay">‚Äî</b></span>
            <span class="pill"><span class="dot blue"></span> Promedio score: <b id="avgScore">‚Äî</b></span>
          </div>

          <div class="divider"></div>

          <h2 style="margin:0 0 8px;">Insights</h2>

          <div class="insightsGrid">
            <div class="miniCard">
              <div class="miniTitle">üéØ Vs semana pasada (100 bots avg)</div>
              <div class="miniValue" id="vsLastWeek">‚Äî</div>
              <div class="miniHint">Menor = mejor. Compara promedios semanales.</div>
            </div>

            <div class="miniCard">
              <div class="miniTitle">üìà Bots avg por semana</div>
              <canvas id="weekChart" width="600" height="220"></canvas>
              <div class="miniHint">√öltimas semanas con datos (promedio de bots avg).</div>
            </div>
          </div>

          <div class="streakWrap">
            <div class="miniTitle">üî• Consistencia (racha)</div>
            <div class="miniValue" id="streakText">‚Äî</div>
            <div class="miniHint" id="streakHint">Meta: 5+ d√≠as seguidos.</div>
            <div class="bar"><div id="streakBar"></div></div>
          </div>

          <div class="divider"></div>

          <h2 style="margin:0 0 8px;">Progreso (d√≠as de la semana)</h2>
          <div class="muted">Se marca si registraste algo ese d√≠a dentro del per√≠odo seleccionado.</div>
          <div class="weekProgress" id="weekProgress"></div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h2 style="margin:0;">Historial</h2>
          <div class="muted" id="countInfo" style="margin-top:6px;">0 registro(s)</div>

          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>D√≠a</th>
                <th>100 bots avg/best</th>
                <th>Hard total (avg/rep)</th>
                <th>DM totals (K/D)</th>
                <th>Score</th>
                <th>Notas</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  const KEY = "valorant_routine_tracker_v5_nats";

  const el = (id) => document.getElementById(id);

  const DOW_SHORT = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
  const DOW_MON_FIRST = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];

  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)) ?? []; }
    catch { return []; }
  }
  function save(items){
    localStorage.setItem(KEY, JSON.stringify(items));
  }
  function safeNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function fmt(n, d=2){
    const p = Math.pow(10,d);
    return (Math.round(n*p)/p).toFixed(d);
  }
  function mean(arr){
    if (!arr.length) return 0;
    return arr.reduce((a,b)=>a+b,0) / arr.length;
  }
  function kd(k, d){
    if (d === 0) return k === 0 ? 0 : k;
    return k / d;
  }
  function dowName(dateStr){
    const d = new Date(dateStr + "T00:00:00");
    return DOW_SHORT[d.getDay()];
  }

  // --- Bots 100 (5 tiempos)
  function botTimesVals(item){
    const arr = Array.isArray(item.botTimes) ? item.botTimes : [];
    return arr.map(n=>Number(n)).filter(n => Number.isFinite(n) && n > 0);
  }
  function botAvg(item){
    const vals = botTimesVals(item);
    return vals.length ? mean(vals) : 0;
  }
  function botBest(item){
    const vals = botTimesVals(item);
    return vals.length ? Math.min(...vals) : 0;
  }

  // --- Hard 15 reps
  function hardVals(item){
    const arr = Array.isArray(item.hardReps) ? item.hardReps : [];
    return arr.map(n=>Number(n)).filter(n => Number.isFinite(n) && n >= 0);
  }
  function hardTotal(item){
    const vals = hardVals(item);
    return vals.reduce((a,b)=>a+b,0);
  }
  function hardAvgRep(item){
    const vals = hardVals(item);
    if (!vals.length) return 0;
    return hardTotal(item) / vals.length;
  }
  function hardBestRep(item){
    const vals = hardVals(item);
    return vals.length ? Math.max(...vals) : 0;
  }

  // --- Deathmatch 5
  function dmPairs(item){
    const arr = Array.isArray(item.dms) ? item.dms : [];
    return arr.map(x => ({ k: Number(x?.k)||0, d: Number(x?.d)||0 }));
  }
  function dmTotals(item){
    const pairs = dmPairs(item);
    const k = pairs.reduce((a,x)=>a+x.k,0);
    const d = pairs.reduce((a,x)=>a+x.d,0);
    return { k, d };
  }
  function dmKDTotal(item){
    const t = dmTotals(item);
    return kd(t.k, t.d);
  }

  // Score compuesto
  function perfScore(item){
    return (hardTotal(item)) + (dmKDTotal(item) * 10) - (botAvg(item) / 10);
  }

  // ISO week key
  function isoWeekKey(dateStr){
    const d = new Date(dateStr + "T00:00:00");
    const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
    d.setDate(d.getDate() - day + 3);
    const firstThursday = new Date(d.getFullYear(), 0, 4);
    const firstDay = (firstThursday.getDay() + 6) % 7;
    firstThursday.setDate(firstThursday.getDate() - firstDay + 3);
    const weekNumber = 1 + Math.round((d - firstThursday) / (7 * 24 * 3600 * 1000));
    const year = d.getFullYear();
    return `${year}-W${String(weekNumber).padStart(2,'0')}`;
  }
  function monthKey(dateStr){
    const d = new Date(dateStr + "T00:00:00");
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }
  function periodKeyByMode(mode, dateStr){
    if (mode === "week") return isoWeekKey(dateStr);
    if (mode === "month") return monthKey(dateStr);
    return "all";
  }
  function uniquePeriods(mode){
    const items = load().filter(x => x.date);
    if (mode === "all") return ["all"];
    const set = new Set(items.map(x => periodKeyByMode(mode, x.date)));
    return Array.from(set).sort((a,b)=> b.localeCompare(a));
  }
  function renderPeriodSelect(){
    const mode = el("viewMode").value;
    const periods = uniquePeriods(mode);
    const ps = el("periodSelect");
    ps.innerHTML = "";
    for (const p of periods){
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = (mode === "all") ? "Todo" : p;
      ps.appendChild(opt);
    }
    ps.value = periods[0] ?? (mode === "all" ? "all" : "");
  }

  function bestWorst(items){
    if (!items.length) return { best:null, worst:null, avgScore:0 };
    let best = items[0], worst = items[0];
    const scores = [];
    for (const it of items){
      const s = perfScore(it);
      scores.push(s);
      if (s > perfScore(best)) best = it;
      if (s < perfScore(worst)) worst = it;
    }
    return { best, worst, avgScore: mean(scores) };
  }

  function renderWeekProgress(items){
    const box = el("weekProgress");
    box.innerHTML = "";

    const has = new Set();
    for (const it of items){
      const d = new Date(it.date + "T00:00:00");
      const dowMonFirst = (d.getDay() + 6) % 7;
      has.add(dowMonFirst);
    }
    for (let i=0;i<7;i++){
      const div = document.createElement("div");
      div.className = "dayBox " + (has.has(i) ? "done" : "miss");
      div.innerHTML = `${DOW_MON_FIRST[i]}<span>${has.has(i) ? "Hecho" : "‚Äî"}</span>`;
      box.appendChild(div);
    }
  }

  // ------- NEW PB: 100 bots best (menor)
  function globalBestBotBest(items){
    const vals = items.map(x => botBest(x)).filter(v => v > 0);
    return vals.length ? Math.min(...vals) : 0;
  }
  function showPBToast(text){
    const t = el("toastPB");
    if (!text){
      t.style.display = "none";
      return;
    }
    t.textContent = "";
    t.append("üèÜ ");
    const b = document.createElement("b");
    b.textContent = "NEW PB";
    t.appendChild(b);
    t.append(" ‚Äî " + text);
    t.style.display = "block";
    setTimeout(()=>{ t.style.display = "none"; }, 4500);
  }

  // ------- Consistencia: racha de d√≠as
  function computeStreak(allItems){
    const dates = Array.from(new Set(allItems.map(x => x.date).filter(Boolean))).sort();
    if (!dates.length) return {streak:0, last:null};

    const last = dates[dates.length - 1];
    let streak = 1;

    function toDayNum(ds){
      const d = new Date(ds + "T00:00:00");
      return Math.floor(d.getTime() / 86400000);
    }

    for (let i = dates.length - 1; i > 0; i--){
      const a = toDayNum(dates[i]);
      const b = toDayNum(dates[i-1]);
      if (a - b === 1) streak++;
      else break;
    }
    return {streak, last};
  }

  // ------- Semana: datos para gr√°fica + comparaci√≥n
  function weeklyBotAvgSeries(allItems){
    // Map: weekKey -> {sum,count}
    const map = new Map();
    for (const it of allItems){
      if (!it.date) continue;
      const a = botAvg(it);
      if (!a) continue;
      const wk = isoWeekKey(it.date);
      const cur = map.get(wk) || {sum:0, count:0};
      cur.sum += a;
      cur.count += 1;
      map.set(wk, cur);
    }
    const keys = Array.from(map.keys()).sort(); // asc
    const series = keys.map(k => ({ week:k, avg: map.get(k).sum / map.get(k).count }));
    return series;
  }

  function drawWeekChart(series){
    const c = el("weekChart");
    const ctx = c.getContext("2d");
    const W = c.width, H = c.height;

    ctx.clearRect(0,0,W,H);

    // background subtle
    ctx.fillStyle = "rgba(255,255,255,0.02)";
    ctx.fillRect(0,0,W,H);

    if (!series.length){
      ctx.fillStyle = "rgba(154,164,199,0.8)";
      ctx.font = "bold 14px Inter, Arial";
      ctx.fillText("Sin datos a√∫n", 16, 32);
      return;
    }

    const lastN = series.slice(Math.max(0, series.length - 8));
    const ys = lastN.map(p => p.avg);
    let minY = Math.min(...ys);
    let maxY = Math.max(...ys);
    if (minY === maxY){ minY -= 1; maxY += 1; }

    const padL = 44, padR = 14, padT = 14, padB = 34;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const xAt = (i) => padL + (plotW * (lastN.length === 1 ? 0 : (i/(lastN.length-1))));
    const yAt = (v) => padT + (plotH * (1 - ((v - minY)/(maxY - minY))));

    // axes
    ctx.strokeStyle = "rgba(27,36,64,0.9)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();

    // y labels (min/max)
    ctx.fillStyle = "rgba(154,164,199,0.85)";
    ctx.font = "bold 12px Inter, Arial";
    ctx.fillText(fmt(maxY,1), 8, padT + 12);
    ctx.fillText(fmt(minY,1), 8, padT + plotH);

    // line
    ctx.strokeStyle = "rgba(110,168,255,0.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    lastN.forEach((p,i)=>{
      const x = xAt(i), y = yAt(p.avg);
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(255,70,85,0.95)";
    lastN.forEach((p,i)=>{
      const x = xAt(i), y = yAt(p.avg);
      ctx.beginPath();
      ctx.arc(x,y,3.5,0,Math.PI*2);
      ctx.fill();
    });

    // x labels (weeks)
    ctx.fillStyle = "rgba(154,164,199,0.75)";
    ctx.font = "bold 11px Inter, Arial";
    lastN.forEach((p,i)=>{
      const label = p.week.slice(5); // "W02"
      const x = xAt(i);
      if (lastN.length > 5 && i % 2 === 1) return; // reduce clutter
      ctx.fillText(label, x-12, padT + plotH + 22);
    });
  }

  function renderVsLastWeek(allItems){
    const series = weeklyBotAvgSeries(allItems);
    if (series.length < 2){
      el("vsLastWeek").textContent = "‚Äî";
      return;
    }
    const cur = series[series.length-1].avg;
    const prev = series[series.length-2].avg;

    // lower is better
    const delta = prev === 0 ? 0 : ((prev - cur) / prev) * 100;
    const arrow = delta > 0 ? "‚¨á" : (delta < 0 ? "‚¨Ü" : "‚Üí"); // ‚¨á mejora (baja el tiempo)
    const cls = delta > 0 ? "deltaUp" : (delta < 0 ? "deltaDown" : "deltaFlat");
    const sign = delta > 0 ? "+" : "";

    el("vsLastWeek").innerHTML = `<span class="${cls}">${arrow} ${sign}${fmt(delta,1)}%</span> ¬∑ ${fmt(cur,1)}s (prev ${fmt(prev,1)}s)`;
  }

  function renderStreak(allItems){
    const {streak, last} = computeStreak(allItems);
    const txt = streak ? `${streak} d√≠a(s) seguidos` : "‚Äî";
    el("streakText").textContent = txt;

    const ok = streak >= 5;
    el("streakHint").textContent = ok
      ? `Nice. Est√°s en modo disciplina (√∫ltimo: ${last}).`
      : (last ? `Sigue: te faltan ${5 - streak} para llegar a 5 (√∫ltimo: ${last}).` : "Meta: 5+ d√≠as seguidos.");

    // bar: cap at 10 days (visual)
    const pct = Math.min(100, (streak / 10) * 100);
    el("streakBar").style.width = pct + "%";
  }

  function render(){
    const mode = el("viewMode").value;
    const period = el("periodSelect").value || (mode === "all" ? "all" : "");

    const allItems = load().slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    const items = (mode === "all") ? allItems : allItems.filter(x => periodKeyByMode(mode, x.date) === period);

    el("countInfo").textContent = `${items.length} registro(s)`;
    el("kpiCount").textContent = String(items.length);

    const last = allItems.length ? allItems[allItems.length-1].date : "‚Äî";
    el("kpiLast").textContent = `√öltimo: ${last}`;

    // KPIs por per√≠odo seleccionado
    const botAvgs = items.map(x => botAvg(x)).filter(x => x > 0);
    const botBests = items.map(x => botBest(x)).filter(x => x > 0);
    const hardTotals = items.map(x => hardTotal(x));
    const hardAvgReps = items.map(x => hardAvgRep(x));
    const dmKDs = items.map(x => dmKDTotal(x));

    el("kpiBotAvg").textContent = botAvgs.length ? `${fmt(mean(botAvgs),1)}s` : "‚Äî";
    el("kpiBotBest").textContent = botBests.length ? `${fmt(Math.min(...botBests),1)}s` : "‚Äî";
    el("kpiHardTotal").textContent = items.length ? fmt(mean(hardTotals),0) : "‚Äî";
    el("kpiHardAvgRep").textContent = items.length ? fmt(mean(hardAvgReps),1) : "‚Äî";
    el("kpiDmKD").textContent = items.length ? fmt(mean(dmKDs),2) : "‚Äî";

    const bw = bestWorst(items);
    el("bestDay").textContent = bw.best ? `${bw.best.date} (${dowName(bw.best.date)})` : "‚Äî";
    el("worstDay").textContent = bw.worst ? `${bw.worst.date} (${dowName(bw.worst.date)})` : "‚Äî";
    el("avgScore").textContent = items.length ? fmt(bw.avgScore,1) : "‚Äî";

    renderWeekProgress(items);

    // Insights (siempre en base a TODO, porque tiene sentido ver tendencia)
    const series = weeklyBotAvgSeries(allItems);
    drawWeekChart(series);
    renderVsLastWeek(allItems);
    renderStreak(allItems);

    // tabla
    const tbody = el("tbody");
    tbody.innerHTML = "";
    for (const x of items.slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""))){
      const bAvg = botAvg(x);
      const bBest = botBest(x);
      const hTot = hardTotal(x);
      const hAvg = hardAvgRep(x);
      const dmt = dmTotals(x);
      const dmkd = dmKDTotal(x);
      const score = perfScore(x);

      const pbTag = x.pbBotBest ? `<span class="tagPB">üèÜ PB</span>` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.date || ""}</td>
        <td>${x.date ? dowName(x.date) : ""}</td>
        <td>${bAvg ? (fmt(bAvg,1) + "s / " + fmt(bBest,1) + "s") : "‚Äî"} ${pbTag}</td>
        <td>${fmt(hTot,0)} (${fmt(hAvg,1)})</td>
        <td>${fmt(dmt.k,0)}-${fmt(dmt.d,0)} (${fmt(dmkd,2)})</td>
        <td>${fmt(score,1)}</td>
        <td>${(x.notes||"").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>
        <td><button data-id="${x.id}">Eliminar</button></td>
      `;
      tr.querySelector("button").addEventListener("click", () => {
        const updated = load().filter(i => i.id !== x.id);
        save(updated);
        renderPeriodSelect();
        render();
      });
      tbody.appendChild(tr);
    }
  }

  function addItem(){
    const date = el("date").value || new Date().toISOString().slice(0,10);

    const botTimes = [];
    for (let i=1;i<=5;i++){
      botTimes.push(Math.max(0, safeNum(el("botT"+i).value)));
    }

    const hardReps = [];
    for (let i=1;i<=15;i++){
      hardReps.push(Math.max(0, Math.floor(safeNum(el("h"+i).value))));
    }

    const dms = [];
    for (let i=1;i<=5;i++){
      const k = Math.max(0, Math.floor(safeNum(el(`dm${i}k`).value)));
      const d = Math.max(0, Math.floor(safeNum(el(`dm${i}d`).value)));
      dms.push({k,d});
    }

    const notes = (el("notes").value || "").trim();

    const itemsBefore = load();
    const prevGlobalBest = globalBestBotBest(itemsBefore); // menor es mejor

    const item = {
      id: crypto.randomUUID(),
      date,
      botTimes,
      hardReps,
      dms,
      notes,
      pbBotBest: false
    };

    // PB check (solo si hay best v√°lido)
    const newBest = botBest(item);
    if (newBest > 0 && (prevGlobalBest === 0 || newBest < prevGlobalBest)){
      item.pbBotBest = true;
    }

    const items = itemsBefore;
    items.push(item);
    save(items);

    // toast PB
    if (item.pbBotBest){
      showPBToast(`100 bots best: ${fmt(newBest,1)}s (antes ${prevGlobalBest ? fmt(prevGlobalBest,1)+"s" : "‚Äî"})`);
    } else {
      showPBToast("");
    }

    // limpiar
    for (let i=1;i<=5;i++){ el("botT"+i).value = ""; }
    for (let i=1;i<=15;i++){ el("h"+i).value = ""; }
    for (let i=1;i<=5;i++){ el(`dm${i}k`).value = ""; el(`dm${i}d`).value = ""; }
    el("notes").value = "";

    renderPeriodSelect();
    render();
  }

  function clearAll(){
    const ok = confirm("¬øSeguro que quieres borrar todo? Esto no se puede deshacer.");
    if (!ok) return;
    localStorage.removeItem(KEY);
    renderPeriodSelect();
    render();
  }

  function exportCSV(){
    const items = load();
    const header = [
      "date","dow",
      "botT1","botT2","botT3","botT4","botT5","botAvg","botBest","pbBotBest",
      "hardR1","hardR2","hardR3","hardR4","hardR5","hardR6","hardR7","hardR8","hardR9","hardR10","hardR11","hardR12","hardR13","hardR14","hardR15",
      "hardTotal","hardAvgRep","hardBestRep",
      "dm1k","dm1d","dm2k","dm2d","dm3k","dm3d","dm4k","dm4d","dm5k","dm5d",
      "dmKillsTotal","dmDeathsTotal","dmKDTotal",
      "score","notes"
    ];

    const rows = items.map(x => {
      const bt = Array.isArray(x.botTimes) ? x.botTimes : [0,0,0,0,0];
      const hr = Array.isArray(x.hardReps) ? x.hardReps : Array(15).fill(0);
      const dms = Array.isArray(x.dms) ? x.dms : Array(5).fill({k:0,d:0});

      const bAvg = botAvg(x), bBest = botBest(x);
      const hTot = hardTotal(x), hAvg = hardAvgRep(x), hBest = hardBestRep(x);
      const dmt = dmTotals(x), dmkd = dmKDTotal(x);
      const score = perfScore(x);

      return [
        x.date,
        x.date ? dowName(x.date) : "",
        bt[0]||0, bt[1]||0, bt[2]||0, bt[3]||0, bt[4]||0,
        bAvg.toFixed(2), bBest.toFixed(2),
        x.pbBotBest ? "1" : "0",
        ...hr,
        hTot, hAvg.toFixed(2), hBest,
        (dms[0]?.k||0),(dms[0]?.d||0),
        (dms[1]?.k||0),(dms[1]?.d||0),
        (dms[2]?.k||0),(dms[2]?.d||0),
        (dms[3]?.k||0),(dms[3]?.d||0),
        (dms[4]?.k||0),(dms[4]?.d||0),
        dmt.k, dmt.d, dmkd.toFixed(4),
        score.toFixed(2),
        (x.notes ?? "").replaceAll('"','""')
      ];
    });

    const csv = [header, ...rows]
      .map(r => r.map(v => `"${String(v)}"`).join(","))
      .join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "valorant_routine_tracker_nats.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // eventos
  el("addBtn").addEventListener("click", addItem);
  el("clearBtn").addEventListener("click", clearAll);
  el("exportBtn").addEventListener("click", exportCSV);

  el("viewMode").addEventListener("change", () => {
    renderPeriodSelect();
    render();
  });
  el("periodSelect").addEventListener("change", () => render());

  // init
  el("date").value = new Date().toISOString().slice(0,10);
  renderPeriodSelect();
  render();
</script>
</body>
</html>
